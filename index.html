<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ff3b7a" />
  <title>Will you be my Valentine?</title>

  <!-- Confetti (optional). Page still works if this fails to load. -->
  <script id="confettiLib" defer src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg1:#ffd6e7;
      --bg2:#ffeef6;
      --card:#ffffffcc;
      --stroke: rgba(255,255,255,.55);
      --shadow: 0 18px 60px rgba(0,0,0,.15);
      --ink:#141414;
      --muted: rgba(0,0,0,.65);

      --yes:#ff3b7a;
      --yesHover:#ff1f68;

      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      min-height:100vh;
      min-height:100svh;
      display:grid;
      place-items:center;
      background: radial-gradient(circle at top, var(--bg2), var(--bg1));
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden;
      padding:
        calc(14px + env(safe-area-inset-top))
        calc(14px + env(safe-area-inset-right))
        calc(14px + env(safe-area-inset-bottom))
        calc(14px + env(safe-area-inset-left));
      color: var(--ink);
    }

    /* Floating hearts background */
    #bgCanvas{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
      z-index:0;
      opacity:.9;
    }

    #confettiCanvas{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      pointer-events:none;
      z-index:9999;
    }

    .card{
      width:min(860px, 94vw);
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align:center;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
      z-index:2;
    }

    .inner{
      padding: 22px 18px 18px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.62);
      font-size: 13px;
      color: var(--muted);
      user-select:none;
    }
    .pill b{ color: var(--ink); font-weight: 900; }

    .mini-actions{
      display:flex;
      gap:8px;
    }

    .icon-btn{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.62);
      cursor:pointer;
      font-size: 16px;
      display:grid;
      place-items:center;
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      transition: transform .12s ease;
    }
    .icon-btn:active{ transform: translateY(1px) scale(.99); }
    .icon-btn:focus-visible{
      outline: 3px solid rgba(255,59,122,.33);
      outline-offset: 3px;
    }

    .screen{ display:none; }
    .screen.active{ display:block; animation: pop .28s ease; }
    @keyframes pop{
      from{ transform: scale(.985); opacity:0; }
      to{ transform: scale(1); opacity:1; }
    }

    .art{
      width: min(280px, 84vw);
      margin: 6px auto 0;
      display:block;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.12));
    }

    h1{
      font-size: clamp(26px, 4.2vw, 46px);
      margin: 12px 0 8px;
      letter-spacing:-.02em;
      line-height: 1.05;
    }

    .sub{
      margin: 0 auto 14px;
      max-width: 62ch;
      color: var(--muted);
      line-height: 1.45;
      font-size: 15px;
    }

    .zone{
      position:relative;
      width: min(560px, 96%);
      height: 170px;
      margin: 10px auto 0;
      touch-action:none;
    }

    .action{
      position:absolute;
      padding: 16px 24px;
      font-size: 18px;
      font-weight: 900;
      border-radius: 999px;
      border:none;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(0,0,0,.14);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, background .12s ease, filter .12s ease;
      transform-origin: center;
    }

    #yesBtn{
      background: var(--yes);
      color:#fff;
    }
    #yesBtn:hover{ background: var(--yesHover); }
    #yesBtn:active{ filter: brightness(.98); }

    #noBtn{
      background: #e9eaf1;
      color:#111827;
    }

    .action:focus-visible{
      outline: 3px solid rgba(255,59,122,.33);
      outline-offset: 4px;
    }

    .hint{
      margin-top: 10px;
      font-size: 13px;
      opacity: .78;
      user-select:none;
    }

    .reason{
      margin: 12px auto 0;
      width:min(560px, 96%);
      border: 1px dashed rgba(255,59,122,.35);
      background: rgba(255,255,255,.55);
      border-radius: 16px;
      padding: 10px 12px;
      font-size: 14px;
      color: rgba(0,0,0,.72);
      display:none;
      gap:10px;
      align-items:flex-start;
      text-align:left;
    }
    .reason.show{ display:flex; }
    .reason .emoji{ font-size: 18px; line-height: 1; }
    .reason .text{ line-height: 1.25; }

    .meter{
      margin: 14px auto 0;
      width:min(560px, 96%);
      height: 14px;
      background: rgba(0,0,0,.06);
      border-radius:999px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
    }
    .meter .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,59,122,.35), rgba(255,59,122,.85));
      border-radius:999px;
      transition: width .18s ease;
    }

    /* YES screen */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      width:min(740px, 100%);
      margin: 14px auto 0;
    }
    @media (min-width: 740px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    .gift{
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.62);
      border-radius: 18px;
      padding: 14px 12px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
      text-align:left;
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-height: 88px;
      position:relative;
    }
    .gift:active{ transform: translateY(1px) scale(.99); }
    .gift:focus-visible{
      outline: 3px solid rgba(255,59,122,.33);
      outline-offset: 4px;
    }
    .gift .icon{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      background: rgba(255,59,122,.12);
      border:1px solid rgba(255,59,122,.18);
      font-size: 18px;
      flex: 0 0 auto;
      user-select:none;
    }
    .gift .title{
      font-weight: 950;
      font-size: 13px;
      margin-top: 2px;
      letter-spacing:.01em;
    }
    .gift .desc{
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
      line-height: 1.25;
    }

    .memories{
      margin: 16px auto 0;
      width:min(740px, 100%);
      border-top: 1px solid rgba(0,0,0,.06);
      padding-top: 14px;
      text-align:left;
    }
    .memories h3{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing:.04em;
      text-transform: uppercase;
      color: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .polaroids{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    @media (min-width: 740px){
      .polaroids{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    .polaroid{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.72);
      padding: 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .polaroid .img{
      border-radius: 14px;
      height: 86px;
      display:grid;
      place-items:center;
      background:
        radial-gradient(100px 70px at 30% 20%, rgba(255,59,122,.20), transparent 60%),
        radial-gradient(110px 80px at 80% 60%, rgba(255,59,122,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
      border:1px solid rgba(0,0,0,.06);
      user-select:none;
      font-size: 28px;
    }
    .polaroid .cap{
      margin-top: 10px;
      font-weight: 900;
      font-size: 13px;
    }
    .polaroid .note{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.38);
      z-index:10000;
      display:none;
      padding:
        calc(14px + env(safe-area-inset-top))
        calc(14px + env(safe-area-inset-right))
        calc(14px + env(safe-area-inset-bottom))
        calc(14px + env(safe-area-inset-left));
    }
    .overlay.open{ display:grid; place-items:center; }

    .modal{
      width: min(860px, 96vw);
      max-height: min(78svh, 760px);
      overflow:auto;
      border-radius: 22px;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.55);
      box-shadow: 0 20px 80px rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 16px 16px 14px;
    }

    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 10px;
      text-align:left;
    }
    .modal-title{
      font-weight: 950;
      font-size: 16px;
      letter-spacing:-.01em;
    }
    .modal-sub{
      margin-top: 2px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.3;
    }
    .close-btn{
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.04);
      border-radius: 12px;
      width: 40px;
      height: 40px;
      cursor:pointer;
      display:grid;
      place-items:center;
      font-size: 18px;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    .close-btn:active{ transform: translateY(1px); }

    .modal-body{
      border-top:1px solid rgba(0,0,0,.06);
      padding-top: 12px;
      text-align:left;
    }

    .modal-page{ display:none; }
    .modal-page.active{ display:block; }

    .letter{
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 15px;
      color: rgba(0,0,0,.84);
      background: rgba(255, 59, 122, .06);
      border: 1px solid rgba(255, 59, 122, .16);
      border-radius: 18px;
      padding: 14px;
    }

    .wheel-wrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      .wheel-wrap{
        grid-template-columns: 340px 1fr;
        gap: 16px;
        align-items:start;
      }
    }
    .pointer{
      width:0;height:0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 22px solid rgba(255,59,122,.95);
      margin: 0 auto -10px;
      filter: drop-shadow(0 10px 12px rgba(0,0,0,.14));
    }
    .wheel{
      width: 320px;
      height: 320px;
      border-radius: 999px;
      border: 10px solid rgba(255,255,255,.7);
      box-shadow: 0 14px 40px rgba(0,0,0,.16);
      margin: 0 auto;
      position:relative;
      user-select:none;
      transform: rotate(0deg);
      transition: transform 4s cubic-bezier(.10,.82,.12,1);
      overflow:hidden;
      background: conic-gradient(rgba(255,59,122,.80), rgba(255,170,200,.80), rgba(255,210,230,.82), rgba(255,59,122,.80));
    }
    .wheel::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.32), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.08), transparent 60%);
      pointer-events:none;
    }
    .wheel-center{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 86px;
      height: 86px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(0,0,0,.06);
      display:grid;
      place-items:center;
      font-weight: 950;
      letter-spacing: .02em;
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .btn{
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, background .12s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{ background: var(--yes); color:#fff; }
    .btn.primary:hover{ background: var(--yesHover); }
    .btn.ghost{
      background: rgba(0,0,0,.05);
      color: rgba(0,0,0,.8);
      border: 1px solid rgba(0,0,0,.08);
    }

    .result-box{
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.03);
      padding: 12px;
      line-height: 1.35;
      color: rgba(0,0,0,.8);
    }

    .ideas{
      margin: 10px 0 0;
      padding: 0;
      list-style:none;
      display:grid;
      gap: 8px;
    }
    .ideas li{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.6);
      color: rgba(0,0,0,.72);
      font-size: 13px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
    }
    .ideas li.selected{
      border-color: rgba(255,59,122,.28);
      background: rgba(255,59,122,.08);
      color: rgba(0,0,0,.84);
      font-weight: 800;
    }
    .ideas .tag{
      font-size: 12px;
      color: rgba(0,0,0,.55);
      white-space:nowrap;
    }

    .coupon{
      border-radius: 20px;
      background:
        radial-gradient(120px 80px at 20% 25%, rgba(255,59,122,.18), transparent 60%),
        radial-gradient(140px 100px at 90% 70%, rgba(255,59,122,.12), transparent 60%),
        rgba(255,255,255,.72);
      border: 1px solid rgba(255,59,122,.18);
      padding: 14px;
    }
    .coupon h4{
      margin: 0 0 6px;
      font-size: 14px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color: rgba(0,0,0,.56);
    }
    .coupon .big{
      margin: 0 0 10px;
      font-size: clamp(18px, 3vw, 22px);
      font-weight: 950;
      letter-spacing:-.01em;
    }
    .coupon .small{
      margin: 0;
      color: rgba(0,0,0,.70);
      line-height:1.35;
      font-size: 13px;
    }
    .scratch-wrap{
      margin-top: 10px;
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.02);
      height: 170px;
    }
    #scratchCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      touch-action:none;
    }
    .scratch-hidden{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      text-align:center;
      padding: 12px;
      gap: 6px;
    }
    .scratch-hidden .msg{
      font-weight: 950;
      font-size: 18px;
    }
    .scratch-hidden .submsg{
      font-size: 13px;
      color: rgba(0,0,0,.64);
      line-height:1.25;
      max-width: 48ch;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: max(16px, env(safe-area-inset-bottom));
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events:none;
      z-index:10001;
      background: rgba(255,255,255,.80);
      border: 1px solid rgba(255,255,255,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 46px rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(0,0,0,.78);
      font-size: 13px;
      transition: opacity .18s ease, transform .18s ease;
      max-width: min(86vw, 720px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      user-select:none;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0px);
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition-duration: .001ms !important; animation-duration: .001ms !important; }
      .wheel{ transition-duration: .001ms !important; }
      #bgCanvas{ display:none; }
    }
  </style>
</head>

<body>
  <canvas id="bgCanvas"></canvas>
  <canvas id="confettiCanvas"></canvas>

  <main class="card" aria-label="Valentine page">
    <div class="inner">
      <div class="topbar">
        <div class="pill">üíå <span>Love level:</span> <b id="loveLevel">0%</b></div>
        <div class="mini-actions">
          <button class="icon-btn" id="shareBtn" title="Share / Copy link" aria-label="Share">‚§¥</button>
          <button class="icon-btn" id="resetAllBtn" title="Reset everything" aria-label="Reset">‚Ü∫</button>
        </div>
      </div>

      <!-- ASK SCREEN -->
      <section class="screen active" id="screenAsk">
        <svg class="art" viewBox="0 0 320 240" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <linearGradient id="fur" x1="0" x2="1">
              <stop offset="0" stop-color="#f7c7a1"/>
              <stop offset="1" stop-color="#f2a97b"/>
            </linearGradient>
            <linearGradient id="heart" x1="0" x2="1">
              <stop offset="0" stop-color="#ff4d7d"/>
              <stop offset="1" stop-color="#ff1f68"/>
            </linearGradient>
          </defs>
          <path d="M250 50 C250 33 270 25 282 38
                   C294 25 314 33 314 50
                   C314 78 282 92 282 106
                   C282 92 250 78 250 50Z" fill="url(#heart)"/>
          <path d="M90 120 C90 70 140 40 190 60
                   C240 40 290 70 290 120
                   C290 180 240 210 190 210
                   C140 210 90 180 90 120Z" fill="url(#fur)"/>
          <path d="M110 92 L95 55 L140 78 Z" fill="#f2a97b"/>
          <path d="M270 92 L285 55 L240 78 Z" fill="#f2a97b"/>
          <circle cx="160" cy="130" r="8"/>
          <circle cx="220" cy="130" r="8"/>
          <path d="M190 144 C186 144 182 148 182 152
                   C182 160 190 164 190 170
                   C190 164 198 160 198 152
                   C198 148 194 144 190 144Z" fill="#ff7aa2"/>
        </svg>

        <h1 id="questionTitle">Kalani, will you be my Valentine?</h1>
        <p class="sub" id="questionSub">Warning: the ‚ÄúNo‚Äù button is on hard mode üòà</p>

        <section class="zone" id="zone" aria-label="Answer buttons">
          <button class="action" id="yesBtn">Yes üíñ</button>
          <button class="action" id="noBtn">No</button>
        </section>

        <div class="hint" id="hint">Try tapping ‚ÄúNo‚Äù üòà</div>

        <div class="reason" id="reasonBox" aria-live="polite">
          <div class="emoji" id="reasonEmoji">üí¨</div>
          <div class="text" id="reasonText"></div>
        </div>

        <div class="meter" aria-hidden="true"><div class="fill" id="meterFill"></div></div>
      </section>

      <!-- YES SCREEN -->
      <section class="screen" id="screenYes">
        <h1>YAY! Officially my Valentine üíò</h1>
        <p class="sub">
          Open the surprises: a love letter, a date spinner, and a scratch-off coupon. (Yes, I‚Äôm extra. It‚Äôs for you.)
        </p>

        <div class="grid" aria-label="Surprises">
          <button class="gift" id="giftLetter" data-page="letter">
            <div class="icon">üíå</div>
            <div>
              <div class="title">Open Love Letter</div>
              <div class="desc">Cute. Sappy. Accurate.</div>
            </div>
          </button>

          <button class="gift" id="giftWheel" data-page="wheel">
            <div class="icon">üé°</div>
            <div>
              <div class="title">Spin a Date Idea</div>
              <div class="desc">We do what the wheel says.</div>
            </div>
          </button>

          <button class="gift" id="giftCoupon" data-page="coupon">
            <div class="icon">üéüÔ∏è</div>
            <div>
              <div class="title">Scratch-Off Coupon</div>
              <div class="desc">Redeemable for kisses.</div>
            </div>
          </button>
        </div>

        <div class="memories">
          <h3>üìå Mini ‚ÄúMemory Lane‚Äù</h3>
          <div class="polaroids" id="polaroids"></div>
        </div>

        <div class="hint" style="margin-top:14px;">P.S. If you refresh, it remembers your progress ü´∂</div>
      </section>
    </div>
  </main>

  <!-- Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <div class="modal-title" id="modalTitle">Modal</div>
          <div class="modal-sub" id="modalSub">Sub</div>
        </div>
        <button class="close-btn" id="closeModalBtn" aria-label="Close">‚úï</button>
      </div>

      <div class="modal-body">
        <section class="modal-page" id="page-letter">
          <div class="letter" id="letterBox"></div>
          <div class="row">
            <button class="btn ghost" id="copyLetterBtn">Copy letter</button>
            <button class="btn primary" id="moreConfettiBtn">More confetti</button>
          </div>
        </section>

        <section class="modal-page" id="page-wheel">
          <div class="wheel-wrap">
            <div>
              <div class="pointer" aria-hidden="true"></div>
              <div class="wheel" id="wheel">
                <div class="wheel-center">SPIN</div>
              </div>
            </div>
            <div>
              <div class="result-box" id="wheelResult">
                <b>Tip:</b> Hit <b>Spin</b> and I‚Äôll pick something adorable for us üíû
              </div>
              <div class="row">
                <button class="btn primary" id="spinBtn">Spin</button>
                <button class="btn ghost" id="copyIdeaBtn" disabled>Copy idea</button>
              </div>
              <ul class="ideas" id="ideaList"></ul>
            </div>
          </div>
        </section>

        <section class="modal-page" id="page-coupon">
          <div class="coupon">
            <h4>Limited edition</h4>
            <p class="big" id="couponTitle">Redeem for: one (1) perfect date</p>
            <p class="small" id="couponDesc">Scratch the area below with your finger ‚ú®</p>
          </div>

          <div class="scratch-wrap" aria-label="Scratch area">
            <div class="scratch-hidden">
              <div class="msg" id="scratchMsg">üíñ 100 KISSES üíñ</div>
              <div class="submsg" id="scratchSubmsg">Redeemable whenever you want. No expiration. (I also get to hug you after.)</div>
            </div>
            <canvas id="scratchCanvas"></canvas>
          </div>

          <div class="row">
            <button class="btn ghost" id="revealBtn">Reveal (if scratching is weird)</button>
            <button class="btn ghost" id="resetScratchBtn">Reset scratch</button>
            <button class="btn primary" id="claimBtn" disabled>Claim reward</button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      "use strict";

      /**********************************************************************
       *  SETTINGS
       **********************************************************************/
      var SETTINGS = {
        herName: "Kalani",
        yourName: "Rishi",
        questionLine: "will you be my Valentine?",
        questionSub: "Warning: the ‚ÄúNo‚Äù button is on hard mode üòà",

        noLabels: ["No", "Nope", "Nuh-uh", "Nice try", "Stoppp üò≠", "Still no", "‚Ä¶maybe?", "Okay fine"],

        reasons: [
          "Because I like you an unreasonable amount.",
          "Because your laugh is basically my favorite sound.",
          "Because you make normal days feel like highlights.",
          "Because I‚Äôm choosing you. Every time.",
          "Because you‚Äôre my favorite person ‚Äî on purpose."
        ],

        memories: [
          { emoji: "üåô", title: "Late-night talks", note: "Time disappears because it‚Äôs you." },
          { emoji: "üòÇ", title: "Your laugh", note: "Instant serotonin. Every time." },
          { emoji: "ü´∂", title: "You & me", note: "My easiest yes." },
          { emoji: "üçì", title: "Little things", note: "The small moments that stay big." },
          { emoji: "üìç", title: "Future plans", note: "More dates. More hugs. More us." },
          { emoji: "üí´", title: "My favorite person", note: "You, always." }
        ],

        letterLines: [
          "Hi {HER} üíñ",
          "I can't wait for Valentine‚Äôs Day this year.",
          "You asked me to show more effort‚Ä¶ so here it is.",
          "I made this little Valentine page just for you.",
          "Thank you for being my person ‚Äî the one I want to tell everything to, celebrate everything with, and choose on the good days and the messy ones.",
          "Even when life is busy or distance is annoying, you‚Äôre still my favorite thought, my favorite notification, and my favorite future.",
          "Happy Valentine‚Äôs Day, baby. I‚Äôm really grateful it‚Äôs you.",
          "Love,",
          "{ME}"
        ],

        dateIdeas: [
          "Dress up + fancy dinner + cute pics",
          "Movie night + snacks + blanket fort",
          "Coffee date + bookstore + pick each other a book",
          "Cook together + taste test + ‚Äòchef kiss‚Äô ratings",
          "Sunset drive + music + park stop",
          "Game night: winner gets kisses (you win)",
          "Dessert crawl (3 places, no regrets)",
          "Museum / aquarium date + matching outfits",
          "Paint night at home + keep the canvases",
          "Write each other mini letters + swap"
        ],

        coupon: {
          title: "Redeem for: one (1) perfect date",
          desc: "Scratch the area below with your finger ‚ú®",
          revealBig: "üíñ 100 KISSES üíñ",
          revealSmall: "Redeemable whenever you want. No expiration. (I also get to hug you after.)"
        }
      };

      /**********************************************************************
       *  Helpers
       **********************************************************************/
      function $(id){ return document.getElementById(id); }
      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
      function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
      function prefersReducedMotion(){
        return !!(window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches);
      }

      /**********************************************************************
       *  State
       **********************************************************************/
      var STATE_KEY = "valentine_state_v5";
      var state = { accepted:false, noCount:0, chosenIdea:"", couponRevealed:false };

      function loadState(){
        try{
          var raw = localStorage.getItem(STATE_KEY);
          if(!raw) return;
          var parsed = JSON.parse(raw);
          if(parsed && typeof parsed === "object"){
            state.accepted = !!parsed.accepted;
            state.noCount = typeof parsed.noCount === "number" ? parsed.noCount : 0;
            state.chosenIdea = typeof parsed.chosenIdea === "string" ? parsed.chosenIdea : "";
            state.couponRevealed = !!parsed.couponRevealed;
          }
        }catch(e){}
      }

      var saveTimer = null;
      function saveStateSoon(){
        if(saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(function(){
          try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch(e){}
        }, 150);
      }

      function hardResetAll(){
        // clear state + storage
        state.accepted = false;
        state.noCount = 0;
        state.chosenIdea = "";
        state.couponRevealed = false;

        try{ localStorage.removeItem(STATE_KEY); }catch(e){}
        // reset UI
        closeModal();
        yesScale = 1;
        applyYesScale();
        reasonBox.classList.remove("show");
        hint.style.display = "";
        setNoLabel();
        updateLoveMeter();
        showAskScreen();
        placeButtons();

        // reset wheel view
        wheelAngle = 0;
        wheel.style.transform = "rotate(0deg)";
        wheelResult.innerHTML = "<b>Tip:</b> Hit <b>Spin</b> and I‚Äôll pick something adorable for us üíû";
        copyIdeaBtn.disabled = true;

        // reset scratch cover
        if(currentModalPage === "coupon"){
          setupScratchCanvas();
          applyCouponRevealedState(false);
        }

        showToast("Reset ‚úÖ");
      }

      loadState();

      /**********************************************************************
       *  Elements
       **********************************************************************/
      var bgCanvas = $("bgCanvas");
      var confettiCanvas = $("confettiCanvas");

      var screenAsk = $("screenAsk");
      var screenYes = $("screenYes");

      var questionTitle = $("questionTitle");
      var questionSub = $("questionSub");

      var zone = $("zone");
      var yesBtn = $("yesBtn");
      var noBtn = $("noBtn");

      var hint = $("hint");
      var reasonBox = $("reasonBox");
      var reasonEmoji = $("reasonEmoji");
      var reasonText = $("reasonText");

      var loveLevel = $("loveLevel");
      var meterFill = $("meterFill");

      var polaroids = $("polaroids");

      var overlay = $("overlay");
      var modalTitle = $("modalTitle");
      var modalSub = $("modalSub");
      var closeModalBtn = $("closeModalBtn");

      var pageLetter = $("page-letter");
      var pageWheel  = $("page-wheel");
      var pageCoupon = $("page-coupon");

      var letterBox = $("letterBox");
      var copyLetterBtn = $("copyLetterBtn");
      var moreConfettiBtn = $("moreConfettiBtn");

      var wheel = $("wheel");
      var spinBtn = $("spinBtn");
      var wheelResult = $("wheelResult");
      var ideaList = $("ideaList");
      var copyIdeaBtn = $("copyIdeaBtn");

      var couponTitle = $("couponTitle");
      var couponDesc = $("couponDesc");
      var scratchCanvas = $("scratchCanvas");
      var scratchMsg = $("scratchMsg");
      var scratchSubmsg = $("scratchSubmsg");
      var revealBtn = $("revealBtn");
      var resetScratchBtn = $("resetScratchBtn");
      var claimBtn = $("claimBtn");

      var giftLetter = $("giftLetter");
      var giftWheel = $("giftWheel");
      var giftCoupon = $("giftCoupon");

      var shareBtn = $("shareBtn");
      var resetAllBtn = $("resetAllBtn");

      var toast = $("toast");
      var toastTimer = null;

      /**********************************************************************
       *  Personalize text
       **********************************************************************/
      questionTitle.textContent = SETTINGS.herName + ", " + SETTINGS.questionLine;
      questionSub.textContent = SETTINGS.questionSub;

      couponTitle.textContent = SETTINGS.coupon.title;
      couponDesc.textContent = SETTINGS.coupon.desc;
      scratchMsg.textContent = SETTINGS.coupon.revealBig;
      scratchSubmsg.textContent = SETTINGS.coupon.revealSmall;

      function buildLetterText(){
        var lines = SETTINGS.letterLines.slice();
        for(var i=0;i<lines.length;i++){
          lines[i] = lines[i].split("{HER}").join(SETTINGS.herName);
          lines[i] = lines[i].split("{ME}").join(SETTINGS.yourName);
        }
        return lines.join("\n");
      }

      /**********************************************************************
       *  Toast
       **********************************************************************/
      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add("show");
        if(toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(function(){ toast.classList.remove("show"); }, 1600);
      }

      /**********************************************************************
       *  Background hearts
       **********************************************************************/
      var bgCtx = bgCanvas.getContext("2d");
      var bgHearts = [];
      var bgDpr = 1;
      var bgLastT = 0;
      var bgRaf = null;

      function resizeBg(){
        bgDpr = Math.max(1, window.devicePixelRatio || 1);
        bgCanvas.width = Math.floor(window.innerWidth * bgDpr);
        bgCanvas.height = Math.floor(window.innerHeight * bgDpr);
        bgCanvas.style.width = window.innerWidth + "px";
        bgCanvas.style.height = window.innerHeight + "px";
      }

      function rand(min, max){ return Math.random() * (max - min) + min; }
      function spawnBgHeart(){
        var emojis = ["‚ù§","üíó","üíñ","üíï"];
        var size = rand(14, 28) * bgDpr;
        return {
          x: rand(0, bgCanvas.width),
          y: bgCanvas.height + rand(0, bgCanvas.height * 0.25),
          vx: rand(-0.22, 0.22) * bgDpr,
          vy: rand(0.25, 0.80) * bgDpr,
          rot: rand(-0.6, 0.6),
          vr: rand(-0.006, 0.006),
          alpha: rand(0.16, 0.40),
          size: size,
          char: emojis[Math.floor(Math.random() * emojis.length)]
        };
      }

      function initBgHearts(){
        bgHearts = [];
        var count = clamp(Math.floor(window.innerWidth / 26), 18, 46);
        for(var i=0;i<count;i++){
          var h = spawnBgHeart();
          h.y = rand(0, bgCanvas.height);
          bgHearts.push(h);
        }
      }

      function drawBg(t){
        if(prefersReducedMotion()) return;
        if(!bgLastT) bgLastT = t;

        var dt = Math.min(0.04, (t - bgLastT) / 1000);
        bgLastT = t;

        bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);

        for(var i=0;i<bgHearts.length;i++){
          var h = bgHearts[i];
          h.x += (h.vx * 60) * dt;
          h.y -= (h.vy * 60) * dt;
          h.rot += (h.vr * 60) * dt;

          if(h.y < -80){
            var nh = spawnBgHeart();
            nh.x = rand(0, bgCanvas.width);
            bgHearts[i] = nh;
            h = nh;
          }
          if(h.x < -80) h.x = bgCanvas.width + 80;
          if(h.x > bgCanvas.width + 80) h.x = -80;

          bgCtx.save();
          bgCtx.globalAlpha = h.alpha;
          bgCtx.translate(h.x, h.y);
          bgCtx.rotate(h.rot);
          bgCtx.font = (h.size) + "px system-ui, sans-serif";
          bgCtx.textAlign = "center";
          bgCtx.textBaseline = "middle";
          bgCtx.fillText(h.char, 0, 0);
          bgCtx.restore();
        }

        bgRaf = requestAnimationFrame(drawBg);
      }

      function startBg(){
        resizeBg();
        initBgHearts();
        if(!prefersReducedMotion()){
          if(bgRaf) cancelAnimationFrame(bgRaf);
          bgLastT = 0;
          bgRaf = requestAnimationFrame(drawBg);
        }
      }

      /**********************************************************************
       *  Confetti (FIXED)
       *  - ensures confetti initializes on first use
       *  - waits for the library to load if it was slow
       **********************************************************************/
      var confettiInstance = null;
      var confettiReady = false;

      function resizeConfettiCanvas(){
        var dpr = Math.max(1, window.devicePixelRatio || 1);
        confettiCanvas.width = Math.floor(window.innerWidth * dpr);
        confettiCanvas.height = Math.floor(window.innerHeight * dpr);
      }

      function tryInitConfetti(){
        if(confettiInstance) { confettiReady = true; return true; }
        try{
          if(window.confetti && typeof window.confetti.create === "function"){
            resizeConfettiCanvas();
            confettiInstance = window.confetti.create(confettiCanvas, { resize: false, useWorker: true });
            confettiReady = true;
            return true;
          }
        }catch(e){}
        return false;
      }

      // Important: hook to script load
      var confettiLib = $("confettiLib");
      if(confettiLib && confettiLib.addEventListener){
        confettiLib.addEventListener("load", function(){
          tryInitConfetti();
        });
      }

      function withConfetti(fn){
        // Attempt init right now. If not ready, retry shortly (covers slow CDN).
        if(tryInitConfetti()){
          fn();
          return;
        }
        showToast("Loading confetti‚Ä¶");
        var tries = 0;
        var timer = setInterval(function(){
          tries++;
          if(tryInitConfetti()){
            clearInterval(timer);
            fn();
          }else if(tries >= 12){
            clearInterval(timer);
            showToast("Confetti blocked üò≠ (still cute)");
          }
        }, 120);
      }

      function miniConfetti(){
        withConfetti(function(){
          confettiInstance({
            particleCount: 90,
            spread: 120,
            startVelocity: 28,
            origin: { x: 0.5, y: 0.35 }
          });
        });
      }

      function fullScreenConfetti(){
        withConfetti(function(){
          var end = Date.now() + 1300;
          (function frame(){
            confettiInstance({
              particleCount: 10,
              spread: 90,
              startVelocity: 28,
              origin: { x: Math.random(), y: Math.random() * 0.30 }
            });
            if(Date.now() < end) requestAnimationFrame(frame);
          })();

          setTimeout(function(){
            confettiInstance({
              particleCount: 260,
              spread: 130,
              startVelocity: 40,
              origin: { x: 0.5, y: 0.45 }
            });
          }, 240);
        });
      }

      /**********************************************************************
       *  Ask screen
       **********************************************************************/
      var yesScale = 1;
      var lastNoChangeAt = 0;
      var NO_COOLDOWN_MS = 850;
      var NO_TRIGGER_DIST = 120;

      function placeButtons(){
        var zW = zone.clientWidth;
        var zH = zone.clientHeight;

        var yTop = Math.round((zH - yesBtn.offsetHeight) / 2);
        var nTop = Math.round((zH - noBtn.offsetHeight) / 2);

        var yesLeft = Math.round(zW * 0.22 - yesBtn.offsetWidth / 2);
        var noLeft  = Math.round(zW * 0.78 - noBtn.offsetWidth / 2);

        yesLeft = clamp(yesLeft, 0, zW - yesBtn.offsetWidth);
        noLeft  = clamp(noLeft, 0, zW - noBtn.offsetWidth);

        yesBtn.style.left = yesLeft + "px";
        yesBtn.style.top  = yTop + "px";

        noBtn.style.left = noLeft + "px";
        noBtn.style.top  = nTop + "px";

        applyYesScale();
      }

      function applyYesScale(){
        yesBtn.style.transform = "scale(" + yesScale.toFixed(3) + ")";
      }

      function setNoLabel(){
        var idx = clamp(state.noCount, 0, SETTINGS.noLabels.length - 1);
        noBtn.textContent = SETTINGS.noLabels[idx];
      }

      function updateLoveMeter(){
        // starts at 100% and drops toward 0% as noCount increases (0..12+)
        var pct = clamp(100 - Math.round((state.noCount / 12) * 100), 0, 100);
        loveLevel.textContent = pct + "%";
        meterFill.style.width = pct + "%";
      }

      function showReason(){
        reasonEmoji.textContent = pick(["üí¨","üòà","ü´∂","ü•π","üíñ"]);
        reasonText.textContent = pick(SETTINGS.reasons);
        reasonBox.classList.add("show");
      }

      function growYes(){
        yesScale = clamp(yesScale + 0.10, 1, 2.25);
        applyYesScale();
      }

      function moveNoAwayFrom(clientX, clientY){
        var zr = zone.getBoundingClientRect();
        var px = clientX - zr.left;
        var py = clientY - zr.top;

        var left = parseFloat(noBtn.style.left) || 0;
        var top  = parseFloat(noBtn.style.top) || 0;
        var bw = noBtn.offsetWidth;
        var bh = noBtn.offsetHeight;

        var bx = left + bw / 2;
        var by = top  + bh / 2;

        var dx = bx - px;
        var dy = by - py;

        var mag = Math.sqrt(dx*dx + dy*dy);
        if(!mag || mag < 0.001){
          dx = (Math.random() - 0.5);
          dy = (Math.random() - 0.5);
          mag = Math.sqrt(dx*dx + dy*dy) || 1;
        }
        dx /= mag;
        dy /= mag;

        var step = 170;
        var newLeft = left + dx * step;
        var newTop  = top  + dy * step;

        newLeft = clamp(newLeft, 0, zone.clientWidth  - bw);
        newTop  = clamp(newTop,  0, zone.clientHeight - bh);

        noBtn.style.left = newLeft + "px";
        noBtn.style.top  = newTop  + "px";
      }

      function pointerDistToNo(clientX, clientY){
        var zr = zone.getBoundingClientRect();
        var px = clientX - zr.left;
        var py = clientY - zr.top;

        var left = parseFloat(noBtn.style.left) || 0;
        var top  = parseFloat(noBtn.style.top) || 0;

        var cx = left + noBtn.offsetWidth / 2;
        var cy = top  + noBtn.offsetHeight / 2;

        var dx = cx - px;
        var dy = cy - py;
        return Math.sqrt(dx*dx + dy*dy);
      }

      function handleNoAttempt(clientX, clientY){
        moveNoAwayFrom(clientX, clientY);

        var now = Date.now();
        if(now - lastNoChangeAt < NO_COOLDOWN_MS) return;
        lastNoChangeAt = now;

        state.noCount += 1;
        saveStateSoon();

        setNoLabel();
        updateLoveMeter();
        showReason();
        growYes();

        if(state.noCount % 2 === 0) miniConfetti();
      }

      zone.addEventListener("pointermove", function(e){
        var d = pointerDistToNo(e.clientX, e.clientY);
        if(d < NO_TRIGGER_DIST) handleNoAttempt(e.clientX, e.clientY);
      }, { passive:true });

      noBtn.addEventListener("pointerdown", function(e){
        e.preventDefault();
        handleNoAttempt(e.clientX, e.clientY);
      });

      noBtn.addEventListener("click", function(e){ e.preventDefault(); });

      yesBtn.addEventListener("click", function(){
        state.accepted = true;
        saveStateSoon();
        showYesScreen();
      });

      /**********************************************************************
       *  Screens
       **********************************************************************/
      function showAskScreen(){
        screenYes.classList.remove("active");
        screenAsk.classList.add("active");
        placeButtons();
      }

      function showYesScreen(){
        screenAsk.classList.remove("active");
        screenYes.classList.add("active");
        hint.style.display = "none";
        reasonBox.classList.remove("show");
        fullScreenConfetti();
        showToast("She said YES üíò");
      }

      /**********************************************************************
       *  Modal
       **********************************************************************/
      var currentModalPage = null;
      var lastFocus = null;

      function setActivePage(name){
        currentModalPage = name;
        pageLetter.classList.toggle("active", name === "letter");
        pageWheel.classList.toggle("active",  name === "wheel");
        pageCoupon.classList.toggle("active", name === "coupon");
      }

      function openModal(pageName){
        lastFocus = document.activeElement;

        overlay.classList.add("open");
        overlay.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";

        if(pageName === "letter"){
          modalTitle.textContent = "üíå A love letter for you";
          modalSub.textContent   = "Effort: delivered ‚ù§Ô∏è";
          setActivePage("letter");
          startLetterTyping();
        }

        if(pageName === "wheel"){
          modalTitle.textContent = "üé° Spin the date idea wheel";
          modalSub.textContent   = "One spin = one plan.";
          setActivePage("wheel");
          renderWheel();
          buildIdeaList();
          syncWheelResultFromState();
        }

        if(pageName === "coupon"){
          modalTitle.textContent = "üéüÔ∏è Scratch-off coupon";
          modalSub.textContent   = "Scratch to reveal your reward (or tap Reveal).";
          setActivePage("coupon");
          requestAnimationFrame(function(){
            setupScratchCanvas();
            applyCouponRevealedState(state.couponRevealed);
          });
        }

        closeModalBtn.focus();
      }

      function closeModal(){
        overlay.classList.remove("open");
        overlay.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
        stopLetterTyping();
        if(lastFocus && lastFocus.focus) lastFocus.focus();
      }

      closeModalBtn.addEventListener("click", closeModal);
      overlay.addEventListener("click", function(e){ if(e.target === overlay) closeModal(); });
      document.addEventListener("keydown", function(e){ if(e.key === "Escape" && overlay.classList.contains("open")) closeModal(); });

      giftLetter.addEventListener("click", function(){ openModal("letter"); miniConfetti(); });
      giftWheel.addEventListener("click",  function(){ openModal("wheel");  miniConfetti(); });
      giftCoupon.addEventListener("click", function(){ openModal("coupon"); miniConfetti(); });

      /**********************************************************************
       *  Letter typing
       **********************************************************************/
      var letterRAF = null;

      function stopLetterTyping(){
        if(letterRAF) cancelAnimationFrame(letterRAF);
        letterRAF = null;
      }

      function startLetterTyping(){
        stopLetterTyping();
        var full = buildLetterText();

        if(prefersReducedMotion()){
          letterBox.textContent = full;
          return;
        }

        letterBox.textContent = "";
        var i = 0;

        function tick(){
          i = Math.min(full.length, i + 3);
          letterBox.textContent = full.slice(0, i);
          if(i < full.length) letterRAF = requestAnimationFrame(tick);
          else letterRAF = null;
        }
        tick();
      }

      copyLetterBtn.addEventListener("click", function(){
        var text = buildLetterText();
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(function(){ showToast("Copied üíñ"); })
            .catch(function(){ window.prompt("Copy the letter:", text); });
        }else{
          window.prompt("Copy the letter:", text);
        }
      });

      // ‚úÖ FIXED: More confetti now always waits for the library if needed
      moreConfettiBtn.addEventListener("click", function(){
        fullScreenConfetti();
        showToast("MORE CONFETTI ‚ú®");
      });

      /**********************************************************************
       *  Wheel (deterministic landing)
       **********************************************************************/
      var wheelAngle = 0;
      var wheelSpinning = false;
      var spinTimer = null;

      function renderWheel(){
        var n = SETTINGS.dateIdeas.length;
        if(!n) return;
        var slice = 360 / n;
        var from = -(slice / 2);
        var colors = ["rgba(255,59,122,.80)","rgba(255,170,200,.80)","rgba(255,210,230,.82)","rgba(255,130,180,.80)"];

        var stops = [];
        for(var i=0;i<n;i++){
          var start = i * slice;
          var end = (i + 1) * slice;
          stops.push(colors[i % colors.length] + " " + start + "deg " + end + "deg");
        }
        wheel.style.background = "conic-gradient(from " + from + "deg, " + stops.join(",") + ")";
      }

      function normalizeDeg(deg){
        deg = deg % 360;
        if(deg < 0) deg += 360;
        return deg;
      }

      function buildIdeaList(){
        ideaList.innerHTML = "";
        for(var i=0;i<SETTINGS.dateIdeas.length;i++){
          var li = document.createElement("li");
          li.innerHTML = '<span>' + SETTINGS.dateIdeas[i] + '</span><span class="tag">#' + (i+1) + '</span>';
          ideaList.appendChild(li);
        }
        highlightIdea(state.chosenIdea);
      }

      function highlightIdea(idea){
        var items = ideaList.children;
        for(var i=0;i<items.length;i++){
          items[i].classList.remove("selected");
          if(SETTINGS.dateIdeas[i] === idea) items[i].classList.add("selected");
        }
      }

      function setWheelResult(idea){
        wheelResult.innerHTML =
          "‚úÖ The wheel chose: <b>" + idea + "</b><br>" +
          '<span style="color:rgba(0,0,0,.62); font-size:13px;">You + me. No excuses. Just vibes.</span>';
        copyIdeaBtn.disabled = false;
        highlightIdea(idea);
      }

      function syncWheelResultFromState(){
        if(state.chosenIdea){
          setWheelResult(state.chosenIdea);
        }else{
          wheelResult.innerHTML = "<b>Tip:</b> Hit <b>Spin</b> and I‚Äôll pick something adorable for us üíû";
          copyIdeaBtn.disabled = true;
        }
      }

      function spinWheel(){
        if(wheelSpinning) return;
        var n = SETTINGS.dateIdeas.length;
        if(!n) return;

        wheelSpinning = true;
        copyIdeaBtn.disabled = true;

        var slice = 360 / n;
        var idx = Math.floor(Math.random() * n);
        var idea = SETTINGS.dateIdeas[idx];

        var target = normalizeDeg(360 - (idx * slice));
        var current = normalizeDeg(wheelAngle);
        var delta = normalizeDeg(target - current);

        var extraSpins = 5 + Math.floor(Math.random() * 2);
        wheelAngle = wheelAngle + extraSpins * 360 + delta;

        wheel.style.transform = "rotate(" + wheelAngle + "deg)";

        var duration = prefersReducedMotion() ? 1 : 4050;
        if(spinTimer) clearTimeout(spinTimer);
        spinTimer = setTimeout(function(){
          wheelSpinning = false;
          state.chosenIdea = idea;
          saveStateSoon();
          setWheelResult(idea);
          miniConfetti();
        }, duration);
      }

      spinBtn.addEventListener("click", spinWheel);

      copyIdeaBtn.addEventListener("click", function(){
        var idea = state.chosenIdea || "";
        if(!idea) return;
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(idea).then(function(){ showToast("Idea copied üíû"); })
            .catch(function(){ window.prompt("Copy the idea:", idea); });
        }else{
          window.prompt("Copy the idea:", idea);
        }
      });

      /**********************************************************************
       *  Scratch (opaque cover + reveal)
       **********************************************************************/
      var scratchCtx = scratchCanvas.getContext("2d");
      var scratching = false;

      function setupScratchCanvas(){
        var rect = scratchCanvas.getBoundingClientRect();
        if(!rect.width || !rect.height) return;

        var dpr = Math.max(1, window.devicePixelRatio || 1);
        scratchCanvas.width  = Math.floor(rect.width * dpr);
        scratchCanvas.height = Math.floor(rect.height * dpr);
        scratchCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
        drawScratchCover();
      }

      function drawScratchCover(){
        var rect = scratchCanvas.getBoundingClientRect();
        if(!rect.width || !rect.height) return;

        scratchCtx.globalCompositeOperation = "source-over";
        scratchCtx.clearRect(0, 0, rect.width, rect.height);

        if(state.couponRevealed) return;

        var w = rect.width, h = rect.height;

        // fully opaque cover
        var g = scratchCtx.createLinearGradient(0,0,w,h);
        g.addColorStop(0, "#7f7f92");
        g.addColorStop(0.5, "#bdbdd0");
        g.addColorStop(1, "#6f6f83");

        scratchCtx.fillStyle = g;
        scratchCtx.fillRect(0, 0, w, h);

        scratchCtx.globalAlpha = 0.18;
        scratchCtx.fillStyle = "rgba(255,255,255,1)";
        scratchCtx.font = "900 16px system-ui";
        scratchCtx.textAlign = "center";
        scratchCtx.textBaseline = "middle";
        scratchCtx.fillText("SCRATCH HERE ‚ú®", w/2, h/2);
        scratchCtx.globalAlpha = 1;
      }

      function scratchAt(clientX, clientY){
        if(state.couponRevealed) return;
        var rect = scratchCanvas.getBoundingClientRect();
        var x = clientX - rect.left;
        var y = clientY - rect.top;

        scratchCtx.globalCompositeOperation = "destination-out";
        scratchCtx.beginPath();
        scratchCtx.arc(x, y, 18, 0, Math.PI * 2);
        scratchCtx.fill();
        scratchCtx.globalCompositeOperation = "source-over";
      }

      function estimateRevealed(){
        var w = scratchCanvas.width;
        var h = scratchCanvas.height;
        if(w === 0 || h === 0) return 0;

        var step = Math.max(10, Math.floor(Math.min(w,h) / 70));
        var img = scratchCtx.getImageData(0,0,w,h).data;

        var total = 0, clear = 0;
        for(var y=0;y<h;y+=step){
          for(var x=0;x<w;x+=step){
            var idx = (y*w + x)*4 + 3;
            total++;
            if(img[idx] < 30) clear++;
          }
        }
        return clear / total;
      }

      function applyCouponRevealedState(revealed){
        state.couponRevealed = !!revealed;
        claimBtn.disabled = !state.couponRevealed;
        saveStateSoon();

        if(state.couponRevealed){
          var rect = scratchCanvas.getBoundingClientRect();
          scratchCtx.globalCompositeOperation = "source-over";
          scratchCtx.clearRect(0,0,rect.width,rect.height);
        }else{
          drawScratchCover();
        }
      }

      scratchCanvas.addEventListener("pointerdown", function(e){
        if(state.couponRevealed) return;
        scratching = true;
        scratchCanvas.setPointerCapture(e.pointerId);
        scratchAt(e.clientX, e.clientY);
      });

      scratchCanvas.addEventListener("pointermove", function(e){
        if(!scratching) return;
        scratchAt(e.clientX, e.clientY);
      });

      function endScratch(){
        if(!scratching) return;
        scratching = false;
        if(state.couponRevealed) return;

        if(estimateRevealed() > 0.55){
          applyCouponRevealedState(true);
          fullScreenConfetti();
          showToast("Reward revealed üò≠üíñ");
        }
      }

      scratchCanvas.addEventListener("pointerup", endScratch);
      scratchCanvas.addEventListener("pointercancel", endScratch);
      scratchCanvas.addEventListener("lostpointercapture", endScratch);

      revealBtn.addEventListener("click", function(){
        applyCouponRevealedState(true);
        fullScreenConfetti();
        showToast("Revealed üíñ");
      });

      resetScratchBtn.addEventListener("click", function(){
        applyCouponRevealedState(false);
        showToast("Reset ‚úÖ");
      });

      claimBtn.addEventListener("click", function(){
        if(!state.couponRevealed) return;
        fullScreenConfetti();
        showToast("Claimed üíã (redeem immediately)");
      });

      /**********************************************************************
       *  Share + Reset
       **********************************************************************/
      shareBtn.addEventListener("click", function(){
        var url = window.location.href;
        var text = "üíò " + SETTINGS.herName + ", will you be my Valentine?";
        if(navigator.share){
          navigator.share({ title: "Valentine üíñ", text: text, url: url }).then(function(){
            showToast("Shared üíå");
          }).catch(function(){});
        }else{
          if(navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(url).then(function(){ showToast("Link copied ‚ú®"); })
              .catch(function(){ window.prompt("Copy this link:", url); });
          }else{
            window.prompt("Copy this link:", url);
          }
        }
      });

      resetAllBtn.addEventListener("click", function(){
        hardResetAll();
      });

      /**********************************************************************
       *  Resize
       **********************************************************************/
      window.addEventListener("resize", function(){
        resizeBg();
        initBgHearts();
        resizeConfettiCanvas();
        if(screenAsk.classList.contains("active")) placeButtons();
        if(overlay.classList.contains("open") && currentModalPage === "coupon") setupScratchCanvas();
      });

      /**********************************************************************
       *  Init
       **********************************************************************/
      function buildMemories(){
        polaroids.innerHTML = "";
        for(var i=0;i<SETTINGS.memories.length;i++){
          var m = SETTINGS.memories[i];
          var d = document.createElement("div");
          d.className = "polaroid";
          d.innerHTML =
            '<div class="img">' + m.emoji + '</div>' +
            '<div class="cap">' + m.title + '</div>' +
            '<div class="note">' + m.note + '</div>';
          polaroids.appendChild(d);
        }
      }

      function init(){
        startBg();
        buildMemories();

        setNoLabel();
        updateLoveMeter();
        placeButtons();

        // prepare confetti sizing, init lazily via withConfetti
        resizeConfettiCanvas();

        if(state.accepted) showYesScreen();
        else showAskScreen();
      }

      init();

    })();
  </script>
</body>
</html>

